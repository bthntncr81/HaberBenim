<div class="x-integration-page">
  <header class="page-header">
    <div class="header-content">
      <h1>ğ• X Integration</h1>
      <p class="subtitle">Configure OAuth2 connection to X (Twitter) API</p>
    </div>
  </header>

  <!-- Settings Section -->
  <section class="settings-section">
    <div class="section-header">
      <h2>âš™ï¸ X API Credentials</h2>
      <p class="hint">X Developer Portal'dan aldÄ±ÄŸÄ±nÄ±z tÃ¼m API bilgilerini buraya girin</p>
    </div>

    @if (isLoadingSettings()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <span>Loading settings...</span>
      </div>
    } @else {
      <div class="settings-form">
        <!-- API Key & Secret -->
        <div class="settings-group">
          <h3>ğŸ”‘ API Keys (Consumer Keys)</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="apiKey">API Key *</label>
              <input 
                type="text" 
                id="apiKey" 
                [(ngModel)]="settings.apiKey"
                placeholder="X API Key (Consumer Key)"
              >
            </div>
            <div class="form-group">
              <label for="apiSecretKey">API Secret Key *</label>
              <input 
                type="password" 
                id="apiSecretKey" 
                [(ngModel)]="settings.apiSecretKey"
                placeholder="X API Secret Key (Consumer Secret)"
              >
            </div>
          </div>
        </div>

        <!-- Bearer Token -->
        <div class="settings-group">
          <h3>ğŸ« Bearer Token</h3>
          <div class="form-group">
            <label for="bearerToken">Bearer Token *</label>
            <input 
              type="password" 
              id="bearerToken" 
              [(ngModel)]="settings.bearerToken"
              placeholder="App-only Bearer Token"
            >
            <span class="hint">Tweet okuma ve kaynak takibi iÃ§in kullanÄ±lÄ±r</span>
          </div>
        </div>

        <!-- Access Token & Secret -->
        <div class="settings-group">
          <h3>ğŸ” Access Token (User Authentication)</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="accessToken">Access Token *</label>
              <input 
                type="password" 
                id="accessToken" 
                [(ngModel)]="settings.accessToken"
                placeholder="User Access Token"
              >
            </div>
            <div class="form-group">
              <label for="accessTokenSecret">Access Token Secret *</label>
              <input 
                type="password" 
                id="accessTokenSecret" 
                [(ngModel)]="settings.accessTokenSecret"
                placeholder="User Access Token Secret"
              >
            </div>
          </div>
          <span class="hint">Tweet paylaÅŸÄ±mÄ± iÃ§in kullanÄ±lÄ±r (OAuth 1.0a)</span>
        </div>

        <!-- OAuth2 Settings (Optional) -->
        <div class="settings-group collapsible">
          <h3>ğŸ”„ OAuth2 AyarlarÄ± (Ä°steÄŸe BaÄŸlÄ±)</h3>
          <p class="hint">OAuth2 PKCE flow kullanmak isterseniz doldurun</p>
          <div class="form-row">
            <div class="form-group">
              <label for="clientId">Client ID</label>
              <input 
                type="text" 
                id="clientId" 
                [(ngModel)]="settings.clientId"
                placeholder="OAuth2 Client ID"
              >
            </div>
            <div class="form-group">
              <label for="clientSecret">Client Secret</label>
              <input 
                type="password" 
                id="clientSecret" 
                [(ngModel)]="settings.clientSecret"
                placeholder="OAuth2 Client Secret"
              >
            </div>
          </div>
          <div class="form-group">
            <label for="redirectUri">Redirect URI</label>
            <input 
              type="text" 
              id="redirectUri" 
              [(ngModel)]="settings.redirectUri"
              placeholder="http://localhost:5078/api/v1/integrations/x/callback"
            >
          </div>
        </div>

        @if (settingsError()) {
          <div class="error-message">{{ settingsError() }}</div>
        }

        <div class="form-actions">
          <button 
            class="btn-save" 
            (click)="saveSettings()"
            [disabled]="isSavingSettings()"
          >
            @if (isSavingSettings()) {
              <span class="spinner-sm"></span>
            }
            ğŸ’¾ AyarlarÄ± Kaydet
          </button>
        </div>
      </div>
    }
  </section>

  <!-- Test Section -->
  <section class="test-section">
    <div class="section-header">
      <h2>ğŸ§ª API BaÄŸlantÄ± Testleri</h2>
      <p class="hint">X API credential'larÄ±nÄ±zÄ± test edin</p>
    </div>

    <!-- Config Status -->
    @if (configStatus()) {
      <div class="config-status">
        <div class="status-row">
          <span class="status-label">OAuth 1.0a (Tweet PaylaÅŸÄ±mÄ±):</span>
          <span class="status-value" [class.configured]="configStatus()!.oauth1.configured" [class.not-configured]="!configStatus()!.oauth1.configured">
            @if (configStatus()!.oauth1.configured) {
              âœ“ YapÄ±landÄ±rÄ±ldÄ±
            } @else {
              âœ• Eksik
            }
          </span>
        </div>
        <div class="status-row">
          <span class="status-label">Bearer Token (Tweet Okuma):</span>
          <span class="status-value" [class.configured]="configStatus()!.oauth2.hasBearerToken" [class.not-configured]="!configStatus()!.oauth2.hasBearerToken">
            @if (configStatus()!.oauth2.hasBearerToken) {
              âœ“ YapÄ±landÄ±rÄ±ldÄ±
            } @else {
              âœ• Eksik
            }
          </span>
        </div>
        <div class="recommendations">
          @for (rec of configStatus()!.recommendations; track rec) {
            <div class="recommendation-item">{{ rec }}</div>
          }
        </div>
      </div>
    }

    <div class="test-buttons">
      <button 
        class="btn-test" 
        (click)="testOAuth1()"
        [disabled]="isTestingOAuth1()"
      >
        @if (isTestingOAuth1()) {
          <span class="spinner-sm"></span>
        }
        ğŸ”‘ OAuth 1.0a Test
      </button>

      <button 
        class="btn-test" 
        (click)="testBearer()"
        [disabled]="isTestingBearer()"
      >
        @if (isTestingBearer()) {
          <span class="spinner-sm"></span>
        }
        ğŸ« Bearer Token Test
      </button>

      <button 
        class="btn-refresh" 
        (click)="loadConfigStatus()"
      >
        ğŸ”„ Durumu Yenile
      </button>
    </div>

    <!-- OAuth1 Test Result -->
    @if (oauth1TestResult()) {
      <div class="test-result" [class.success]="oauth1TestResult()!.success" [class.error]="!oauth1TestResult()!.success">
        @if (oauth1TestResult()!.success) {
          <span class="icon">âœ“</span>
          <span>OAuth 1.0a Ã§alÄ±ÅŸÄ±yor! BaÄŸlÄ± hesap: &#64;{{ oauth1TestResult()!.user?.username }}</span>
        } @else {
          <span class="icon">âœ•</span>
          <span>{{ oauth1TestResult()!.message }}</span>
          @if (oauth1TestResult()!.error) {
            <div class="error-detail">{{ oauth1TestResult()!.error }}</div>
          }
        }
      </div>
    }

    <!-- Bearer Test Result -->
    @if (bearerTestResult()) {
      <div class="test-result" [class.success]="bearerTestResult()!.success" [class.error]="!bearerTestResult()!.success">
        @if (bearerTestResult()!.success) {
          <span class="icon">âœ“</span>
          <span>Bearer Token Ã§alÄ±ÅŸÄ±yor! {{ bearerTestResult()!.resultCount }} tweet bulundu.</span>
        } @else {
          <span class="icon">âœ•</span>
          <span>{{ bearerTestResult()!.message }}</span>
          @if (bearerTestResult()!.error) {
            <div class="error-detail">{{ bearerTestResult()!.error }}</div>
          }
        }
      </div>
    }

    <!-- Test Tweet Section -->
    <div class="test-tweet-section">
      <h3>ğŸ“ Test Tweet</h3>
      <div class="test-tweet-form">
        <textarea 
          [(ngModel)]="testTweetText"
          placeholder="Test tweet metni yazÄ±n... (max 280 karakter)"
          maxlength="280"
          rows="3"
        ></textarea>
        <div class="tweet-actions">
          <span class="char-count">{{ testTweetText.length }}/280</span>
          <button 
            class="btn-tweet"
            (click)="testTweet()"
            [disabled]="isTestingPost() || !testTweetText.trim()"
          >
            @if (isTestingPost()) {
              <span class="spinner-sm"></span>
            }
            ğ• Tweet GÃ¶nder
          </button>
        </div>
      </div>
      
      @if (testPostResult()) {
        <div class="test-result" [class.success]="testPostResult()!.success" [class.error]="!testPostResult()!.success">
          @if (testPostResult()!.success) {
            <span class="icon">âœ“</span>
            <span>Tweet baÅŸarÄ±yla gÃ¶nderildi!</span>
            @if (testPostResult()!.tweet) {
              <a [href]="testPostResult()!.tweet?.url" target="_blank" class="tweet-link">
                Tweet'i gÃ¶rÃ¼ntÃ¼le â†’
              </a>
            }
          } @else {
            <span class="icon">âœ•</span>
            <span>{{ testPostResult()!.message }}</span>
          }
        </div>
      }
    </div>
  </section>

  <!-- Ingestion Status Section -->
  <section class="ingestion-section">
    <div class="section-header">
      <h2>ğŸ“¡ X Kaynak Ã‡ekme (Ingestion)</h2>
      <p class="hint">X kaynaklarÄ±ndan tweet Ã§ekme durumu ve manuel tetikleme</p>
    </div>

    <div class="ingestion-actions">
      <button 
        class="btn-trigger"
        (click)="triggerIngestion()"
        [disabled]="isTriggeringIngestion()"
      >
        @if (isTriggeringIngestion()) {
          <span class="spinner-sm"></span>
        }
        âš¡ TÃ¼m KaynaklarÄ± Ã‡ek
      </button>

      <button 
        class="btn-refresh"
        (click)="loadIngestionStatus()"
        [disabled]="isLoadingIngestion()"
      >
        ğŸ”„ Durumu Yenile
      </button>
    </div>

    @if (isLoadingIngestion()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <span>Loading ingestion status...</span>
      </div>
    } @else if (ingestionStatus()) {
      <div class="ingestion-summary">
        <div class="summary-card">
          <span class="label">Credential</span>
          <span class="value" [class.configured]="ingestionStatus()!.hasCredentials" [class.not-configured]="!ingestionStatus()!.hasCredentials">
            {{ ingestionStatus()!.credentialType }}
          </span>
        </div>
        <div class="summary-card">
          <span class="label">X KaynaklarÄ±</span>
          <span class="value">{{ ingestionStatus()!.totalXSources }}</span>
        </div>
        <div class="summary-card">
          <span class="label">X Ä°Ã§erikleri</span>
          <span class="value">{{ ingestionStatus()!.xContentItems }}</span>
        </div>
        <div class="summary-card">
          <span class="label">Toplam Ä°Ã§erik</span>
          <span class="value">{{ ingestionStatus()!.totalContentItems }}</span>
        </div>
      </div>

      @if (ingestionStatus()!.sources.length > 0) {
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Kaynak</th>
                <th>Identifier</th>
                <th>X User ID</th>
                <th>Son Ã‡ekim</th>
                <th>Durum</th>
                <th>Ä°Ã§erik</th>
                <th>Aksiyon</th>
              </tr>
            </thead>
            <tbody>
              @for (source of ingestionStatus()!.sources; track source.sourceId) {
                <tr [class.has-error]="source.consecutiveFailures > 0">
                  <td class="source-name">{{ source.sourceName }}</td>
                  <td class="identifier">&#64;{{ source.identifier }}</td>
                  <td class="x-user-id">
                    @if (source.xUserId) {
                      <span class="resolved">{{ source.xUserId }}</span>
                    } @else {
                      <span class="not-resolved">HenÃ¼z Ã§Ã¶zÃ¼mlenmedi</span>
                    }
                  </td>
                  <td class="last-poll">
                    @if (source.lastSuccessAt) {
                      {{ formatDate(source.lastSuccessAt) }}
                    } @else {
                      <span class="never">HiÃ§ Ã§ekilmedi</span>
                    }
                  </td>
                  <td class="status">
                    @if (source.consecutiveFailures > 0) {
                      <span class="error-badge" [title]="source.lastError || ''">
                        âš ï¸ {{ source.consecutiveFailures }} hata
                      </span>
                    } @else if (source.lastSuccessAt) {
                      <span class="success-badge">âœ“ BaÅŸarÄ±lÄ±</span>
                    } @else {
                      <span class="pending-badge">â³ Bekliyor</span>
                    }
                  </td>
                  <td class="content-count">{{ source.contentItemCount }}</td>
                  <td class="actions">
                    <button 
                      class="btn-action trigger"
                      (click)="triggerSourceIngestion(source)"
                      [disabled]="triggeringSourceId() === source.sourceId"
                      title="Bu kaynaÄŸÄ± ÅŸimdi Ã§ek"
                    >
                      @if (triggeringSourceId() === source.sourceId) {
                        <span class="spinner-sm"></span>
                      } @else {
                        âš¡
                      }
                    </button>
                  </td>
                </tr>
                @if (source.lastError) {
                  <tr class="error-row">
                    <td colspan="7" class="error-message">
                      Son Hata: {{ source.lastError }}
                    </td>
                  </tr>
                }
              }
            </tbody>
          </table>
        </div>
      } @else {
        <div class="empty-state">
          <span class="empty-icon">ğŸ“¡</span>
          <p>HenÃ¼z aktif X kaynaÄŸÄ± yok</p>
          <p class="hint">Sources sayfasÄ±ndan X tipi kaynak ekleyin</p>
        </div>
      }
    }
  </section>

  <!-- Connect Section (OAuth2 PKCE) -->
  <section class="connect-section">
    <div class="section-header">
      <h2>ğŸ”— OAuth2 PKCE BaÄŸlantÄ±sÄ±</h2>
      <p class="hint">Alternatif: OAuth2 ile X hesabÄ±nÄ±za baÄŸlanÄ±n</p>
    </div>

    <div class="connect-actions">
      <button 
        class="btn-connect" 
        (click)="connectToX()"
        [disabled]="isConnecting()"
      >
        @if (isConnecting()) {
          <span class="spinner-sm"></span>
          Waiting for authorization...
        } @else {
          ğ• Connect to X
        }
      </button>

      <button 
        class="btn-test" 
        (click)="testConnection()"
        [disabled]="isTesting()"
      >
        @if (isTesting()) {
          <span class="spinner-sm"></span>
        }
        ğŸ” Test OAuth2
      </button>

      <button 
        class="btn-refresh" 
        (click)="loadConnections()"
        [disabled]="isLoadingConnections()"
      >
        ğŸ”„ Refresh
      </button>
    </div>

    @if (testResult()) {
      <div class="test-result" [class.success]="testResult()!.connected" [class.error]="!testResult()!.connected">
        @if (testResult()!.connected) {
          <span class="icon">âœ“</span>
          <span>Connected as &#64;{{ testResult()!.username }}</span>
        } @else {
          <span class="icon">âœ•</span>
          <span>{{ testResult()!.message }}</span>
        }
      </div>
    }
  </section>

  <!-- Connections Table -->
  <section class="connections-section">
    <div class="section-header">
      <h2>ğŸ“‹ Connected Accounts</h2>
    </div>

    @if (isLoadingConnections()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <span>Loading connections...</span>
      </div>
    } @else if (connectionsError()) {
      <div class="error-state">
        <span>{{ connectionsError() }}</span>
        <button class="btn-retry" (click)="loadConnections()">Retry</button>
      </div>
    } @else if (connections().length === 0) {
      <div class="empty-state">
        <span class="empty-icon">ğŸ”Œ</span>
        <p>No X accounts connected yet</p>
        <p class="hint">Click "Connect to X" to add your first account</p>
      </div>
    } @else {
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Account</th>
              <th>Scopes</th>
              <th>Expires</th>
              <th>Default</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (conn of connections(); track conn.id) {
              <tr [class.inactive]="!conn.isActive">
                <td class="account-cell">
                  <span class="x-icon">ğ•</span>
                  <div class="account-info">
                    <span class="username">&#64;{{ conn.xUsername }}</span>
                    <span class="user-id">ID: {{ conn.xUserId }}</span>
                  </div>
                </td>
                <td class="scopes-cell">
                  <div class="scopes-list">
                    @for (scope of conn.scopes.split(' '); track scope) {
                      <span class="scope-badge">{{ scope }}</span>
                    }
                  </div>
                </td>
                <td class="expires-cell">
                  <span [class.expiring-soon]="isExpiringSoon(conn.expiresAtUtc)">
                    {{ formatDate(conn.expiresAtUtc) }}
                  </span>
                  @if (isExpiringSoon(conn.expiresAtUtc)) {
                    <span class="warning-badge">âš ï¸ Expiring</span>
                  }
                </td>
                <td class="default-cell">
                  @if (conn.isDefaultPublisher) {
                    <span class="default-badge">âœ“ Default</span>
                  } @else {
                    <span class="not-default">-</span>
                  }
                </td>
                <td class="status-cell">
                  @if (conn.isActive) {
                    <span class="status-badge active">Active</span>
                  } @else {
                    <span class="status-badge inactive">Inactive</span>
                  }
                </td>
                <td class="actions-cell">
                  @if (!conn.isDefaultPublisher && conn.isActive) {
                    <button 
                      class="btn-action"
                      (click)="setDefault(conn)"
                      [disabled]="settingDefaultId() === conn.id"
                      title="Set as default publisher"
                    >
                      @if (settingDefaultId() === conn.id) {
                        <span class="spinner-sm"></span>
                      } @else {
                        â­
                      }
                    </button>
                  }
                  @if (conn.isActive) {
                    <button 
                      class="btn-action disconnect"
                      (click)="disconnect(conn)"
                      [disabled]="disconnectingId() === conn.id"
                      title="Disconnect"
                    >
                      @if (disconnectingId() === conn.id) {
                        <span class="spinner-sm"></span>
                      } @else {
                        ğŸ”Œ
                      }
                    </button>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </section>
</div>

<!-- Toast -->
@if (showToast()) {
  <div class="toast" [class]="toastType()">
    {{ toastMessage() }}
  </div>
}

