<div class="page">
  <!-- Header -->
  <header class="page-header">
    <div class="header-content">
      <h1>üîó News Sources</h1>
      <p>
        @if (isAdmin()) {
          Manage RSS feeds, X accounts, and other news sources
        } @else {
          View RSS feeds, X accounts, and other news sources (read-only)
        }
      </p>
    </div>
    @if (isAdmin()) {
      <button class="btn-add" (click)="openAddModal()">+ Add Source</button>
    }
  </header>

  <!-- Filters -->
  <div class="filters-card">
    <div class="filters-row">
      <div class="filter-group">
        <label>Search</label>
        <input 
          type="text" 
          [(ngModel)]="searchQuery" 
          placeholder="Name or identifier..."
          (keyup.enter)="onSearch()"
        >
      </div>
      <div class="filter-group">
        <label>Type</label>
        <select [(ngModel)]="typeFilter">
          <option value="">All Types</option>
          @for (type of sourceTypes; track type.value) {
            <option [value]="type.value">{{ type.label }}</option>
          }
        </select>
      </div>
      <div class="filter-group">
        <label>Category</label>
        <select [(ngModel)]="categoryFilter">
          <option value="">All Categories</option>
          @for (cat of categories; track cat) {
            <option [value]="cat">{{ cat }}</option>
          }
        </select>
      </div>
      <div class="filter-group">
        <label>Status</label>
        <select [(ngModel)]="activeFilter">
          <option value="">All</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>
      <div class="filter-actions">
        <button class="btn-search" (click)="onSearch()">üîç Search</button>
        <button class="btn-clear" (click)="onClearFilters()">Clear</button>
      </div>
    </div>
  </div>

  <!-- Results Info -->
  <div class="results-info">
    <span>{{ total() }} sources found</span>
  </div>

  <!-- Sources List -->
  @if (isLoading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <span>Loading sources...</span>
    </div>
  } @else if (error()) {
    <div class="error-state">
      <span>{{ error() }}</span>
      <button class="btn-retry" (click)="loadSources()">Retry</button>
    </div>
  } @else if (sources().length === 0) {
    <div class="empty-state">
      <span class="empty-icon">üì≠</span>
      <p>No sources found</p>
      <button class="btn-add-empty" (click)="openAddModal()">Add your first source</button>
    </div>
  } @else {
    <div class="sources-list">
      @for (source of sources(); track source.id) {
        <div class="source-card" [class.inactive]="!source.isActive">
          <div class="source-header">
            <div class="source-title">
              <span class="type-icon">{{ getTypeIcon(source.type) }}</span>
              <h3>{{ source.name }}</h3>
              <span class="type-badge" [class]="source.type.toLowerCase()">{{ source.type }}</span>
              <span class="category-badge">{{ source.category }}</span>
            </div>
            @if (isAdmin()) {
              <div class="source-actions">
                <button 
                  class="btn-icon edit" 
                  (click)="openEditModal(source)"
                  title="Edit"
                >
                  ‚úèÔ∏è
                </button>
                <button 
                  class="btn-icon toggle" 
                  [class.active]="source.isActive"
                  (click)="toggleActive(source)"
                  [disabled]="togglingId() === source.id"
                  [title]="source.isActive ? 'Deactivate' : 'Activate'"
                >
                  @if (togglingId() === source.id) {
                    <span class="spinner-xs"></span>
                  } @else {
                    {{ source.isActive ? '‚úì' : '‚óã' }}
                  }
                </button>
                <button 
                  class="btn-icon delete" 
                  (click)="deleteSource(source)"
                  [disabled]="deletingId() === source.id"
                  title="Delete"
                >
                  @if (deletingId() === source.id) {
                    <span class="spinner-xs"></span>
                  } @else {
                    üóëÔ∏è
                  }
                </button>
              </div>
            }
          </div>

          <div class="source-body">
            <div class="source-meta">
              @if (source.type === 'X' && source.identifier) {
                <div class="meta-item">
                  <span class="label">Username:</span>
                  <span class="value x-username">&#64;{{ source.identifier }}</span>
                </div>
              }
              @if (source.url) {
                <div class="meta-item">
                  <span class="label">URL:</span>
                  <span class="value url">{{ source.url }}</span>
                </div>
              }
              <div class="meta-item">
                <span class="label">Trust:</span>
                <span class="value">
                  <span class="trust-bar">
                    <span class="trust-fill" [style.width.%]="source.trustLevel"></span>
                  </span>
                  {{ source.trustLevel }}
                </span>
              </div>
              <div class="meta-item">
                <span class="label">Priority:</span>
                <span class="value">{{ source.priority }}</span>
              </div>
              <div class="meta-item">
                <span class="label">Behavior:</span>
                <span class="value behavior-badge" [class]="source.defaultBehavior.toLowerCase()">
                  {{ source.defaultBehavior }}
                </span>
              </div>
            </div>
            
            <!-- X Source State -->
            @if (source.type === 'X') {
              <div class="x-state-section">
                @if (source.isLoadingState) {
                  <div class="x-state-loading">
                    <span class="spinner-sm"></span>
                    Loading X state...
                  </div>
                } @else if (source.xState) {
                  <div class="x-state-grid">
                    <div class="state-item">
                      <span class="state-label">X User ID</span>
                      <span class="state-value">{{ source.xState.xUserId || 'Not resolved' }}</span>
                    </div>
                    <div class="state-item">
                      <span class="state-label">Last Since ID</span>
                      <span class="state-value mono">{{ source.xState.lastSinceId || '-' }}</span>
                    </div>
                    <div class="state-item">
                      <span class="state-label">Last Polled</span>
                      <span class="state-value">{{ formatRelativeTime(source.xState.lastPolledAtUtc) }}</span>
                    </div>
                    <div class="state-item">
                      <span class="state-label">Last Success</span>
                      <span class="state-value" [class.success]="source.xState.lastSuccessAtUtc">
                        {{ formatRelativeTime(source.xState.lastSuccessAtUtc) }}
                      </span>
                    </div>
                    @if (source.xState.lastError) {
                      <div class="state-item full-width error">
                        <span class="state-label">Last Error</span>
                        <span class="state-value error-text">{{ source.xState.lastError }}</span>
                      </div>
                    }
                  </div>
                } @else {
                  <div class="x-state-empty">
                    <span>No X state available</span>
                  </div>
                }
              </div>
            }
          </div>

          <div class="source-footer">
            <span class="meta">Updated: {{ formatRelativeTime(source.updatedAtUtc) }}</span>
            <span class="status-indicator" [class.active]="source.isActive">
              {{ source.isActive ? '‚óè Active' : '‚óã Inactive' }}
            </span>
          </div>
        </div>
      }
    </div>
  }

  <!-- Pagination -->
  @if (totalPages > 1) {
    <div class="pagination">
      <button 
        class="btn-page" 
        [disabled]="page() <= 1"
        (click)="onPageChange(page() - 1)"
      >
        ‚Üê Previous
      </button>
      
      <div class="page-numbers">
        @for (pageNum of getPageNumbers(); track pageNum) {
          @if (pageNum === -1) {
            <span class="ellipsis">...</span>
          } @else {
            <button 
              class="btn-page-num" 
              [class.active]="pageNum === page()"
              (click)="onPageChange(pageNum)"
            >
              {{ pageNum }}
            </button>
          }
        }
      </div>
      
      <button 
        class="btn-page" 
        [disabled]="page() >= totalPages"
        (click)="onPageChange(page() + 1)"
      >
        Next ‚Üí
      </button>
    </div>
  }
</div>

<!-- Add/Edit Source Modal -->
@if (showAddModal() || showEditModal()) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingSource() ? '‚úèÔ∏è Edit Source' : '‚ûï Add Source' }}</h2>
        <button class="btn-close" (click)="closeModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group" [class.has-error]="formErrors()['name']">
            <label>Name *</label>
            <input 
              type="text" 
              [(ngModel)]="formData.name" 
              placeholder="e.g., Reuters, TechCrunch"
              maxlength="120"
            >
            @if (formErrors()['name']) {
              <span class="error">{{ formErrors()['name'] }}</span>
            }
          </div>
          <div class="form-group" [class.has-error]="formErrors()['type']">
            <label>Type *</label>
            <select [(ngModel)]="formData.type" [disabled]="!!editingSource()">
              @for (type of sourceTypes; track type.value) {
                <option [value]="type.value">{{ type.label }}</option>
              }
            </select>
            @if (formErrors()['type']) {
              <span class="error">{{ formErrors()['type'] }}</span>
            }
          </div>
        </div>
        
        @if (formData.type === 'X') {
          <div class="form-group" [class.has-error]="formErrors()['identifier']">
            <label>X Username *</label>
            <input 
              type="text" 
              [(ngModel)]="formData.identifier" 
              placeholder="username (without &#64;)"
            >
            @if (formErrors()['identifier']) {
              <span class="error">{{ formErrors()['identifier'] }}</span>
            } @else {
              <span class="hint">Enter the X username to follow (&#64; will be stripped)</span>
            }
          </div>
        }
        
        @if (formData.type === 'RSS' || formData.type === 'GoogleNews') {
          <div class="form-group" [class.has-error]="formErrors()['url']">
            <label>Feed URL {{ formData.type === 'RSS' ? '*' : '' }}</label>
            <input 
              type="url" 
              [(ngModel)]="formData.url" 
              placeholder="https://example.com/feed.xml"
            >
            @if (formErrors()['url']) {
              <span class="error">{{ formErrors()['url'] }}</span>
            }
          </div>
        }
        
        <!-- RSS Full-Text Enrichment Settings (only for RSS type) -->
        @if (formData.type === 'RSS') {
          <div class="form-section">
            <h4>üìÑ Full-Text Enrichment</h4>
            <p class="section-hint">Fetch full article content when RSS provides truncated summaries</p>
            
            <div class="form-group checkbox">
              <label>
                <input type="checkbox" [(ngModel)]="formData.fullTextFetchEnabled">
                Enable Full-Text Fetch
              </label>
              <span class="hint">When enabled, truncated content will be fetched from the source URL</span>
            </div>
            
            @if (formData.fullTextFetchEnabled) {
              <div class="form-group">
                <label>Extraction Mode</label>
                <select [(ngModel)]="formData.fullTextExtractMode">
                  @for (mode of fullTextExtractModes; track mode.value) {
                    <option [value]="mode.value">{{ mode.label }}</option>
                  }
                </select>
                <span class="hint">Auto tries JSON-LD first, then falls back to Readability-style extraction</span>
              </div>
            }
          </div>
        }
        
        <div class="form-row">
          <div class="form-group">
            <label>Category *</label>
            <select [(ngModel)]="formData.category">
              @for (cat of categories; track cat) {
                <option [value]="cat">{{ cat }}</option>
              }
            </select>
          </div>
          <div class="form-group">
            <label>Default Behavior *</label>
            <select [(ngModel)]="formData.defaultBehavior">
              @for (behavior of defaultBehaviors; track behavior.value) {
                <option [value]="behavior.value">{{ behavior.label }}</option>
              }
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group" [class.has-error]="formErrors()['trustLevel']">
            <label>Trust Level (0-100)</label>
            <input 
              type="number" 
              [(ngModel)]="formData.trustLevel" 
              min="0" 
              max="100"
            >
            @if (formErrors()['trustLevel']) {
              <span class="error">{{ formErrors()['trustLevel'] }}</span>
            }
          </div>
          <div class="form-group" [class.has-error]="formErrors()['priority']">
            <label>Priority (0-1000)</label>
            <input 
              type="number" 
              [(ngModel)]="formData.priority" 
              min="0" 
              max="1000"
            >
            @if (formErrors()['priority']) {
              <span class="error">{{ formErrors()['priority'] }}</span>
            }
          </div>
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea 
            [(ngModel)]="formData.description" 
            placeholder="Optional description..."
            rows="3"
          ></textarea>
        </div>
        
        <div class="form-group checkbox">
          <label>
            <input type="checkbox" [(ngModel)]="formData.isActive">
            Active (enable ingestion)
          </label>
        </div>
        
        <!-- Template Assignments Section (Edit Mode Only) -->
        @if (editingSource()) {
          <div class="form-section templates-section">
            <h4>üé® Template Assignments</h4>
            <p class="section-hint">Assign templates to this source for different platforms</p>
            
            <!-- Platform Tabs -->
            <div class="platform-tabs">
              @for (platform of platforms; track platform) {
                <button 
                  class="platform-tab"
                  [class.active]="activePlatformTab() === platform"
                  (click)="setPlatformTab(platform)"
                >
                  {{ platform }}
                  <span class="count">{{ getTemplatesForPlatform(platform).length }}</span>
                </button>
              }
            </div>
            
            <!-- Current Assignments -->
            <div class="assignments-list">
              @if (isLoadingTemplates()) {
                <div class="loading-inline">
                  <span class="spinner-xs"></span> Loading templates...
                </div>
              } @else {
                @if (getTemplatesForPlatform(activePlatformTab()).length === 0) {
                  <div class="no-templates">
                    <span>No templates assigned for {{ activePlatformTab() }}</span>
                  </div>
                } @else {
                  @for (assignment of getTemplatesForPlatform(activePlatformTab()); track assignment.id) {
                    <div class="assignment-row" [class.inactive]="!assignment.isActive">
                      <div class="assignment-info">
                        <span class="template-name">{{ assignment.templateName }}</span>
                        <span class="template-format">{{ assignment.templateFormat }}</span>
                        <span class="template-priority">
                          P: {{ assignment.effectivePriority }}
                          @if (assignment.priorityOverride !== null) {
                            (override)
                          }
                        </span>
                      </div>
                      <div class="assignment-actions">
                        <input 
                          type="number" 
                          class="priority-input"
                          [value]="assignment.priorityOverride ?? ''"
                          placeholder="Pri"
                          (blur)="updateAssignmentPriority(assignment, $any($event.target).value ? +$any($event.target).value : null)"
                        >
                        <button 
                          class="btn-icon toggle"
                          [class.active]="assignment.isActive"
                          (click)="toggleAssignmentActive(assignment)"
                          [disabled]="isTogglingAssignment() === assignment.id"
                          [title]="assignment.isActive ? 'Disable' : 'Enable'"
                        >
                          @if (isTogglingAssignment() === assignment.id) {
                            <span class="spinner-xs"></span>
                          } @else {
                            {{ assignment.isActive ? '‚úì' : '‚óã' }}
                          }
                        </button>
                        <button 
                          class="btn-icon delete"
                          (click)="deleteAssignment(assignment)"
                          [disabled]="isDeletingAssignment() === assignment.id"
                          title="Remove"
                        >
                          @if (isDeletingAssignment() === assignment.id) {
                            <span class="spinner-xs"></span>
                          } @else {
                            üóëÔ∏è
                          }
                        </button>
                      </div>
                    </div>
                  }
                }
              }
            </div>
            
            <!-- Add Template -->
            <div class="add-template-row">
              <select 
                class="template-select"
                [ngModel]="selectedTemplateToAdd()"
                (ngModelChange)="selectedTemplateToAdd.set($event)"
                [disabled]="isLoadingTemplateOptions() || isAddingAssignment()"
              >
                <option value="">Select a template...</option>
                @for (tpl of getAvailableTemplatesForPlatform(activePlatformTab()); track tpl.id) {
                  <option [value]="tpl.id">{{ tpl.name }} ({{ tpl.format }}) - P:{{ tpl.priority }}</option>
                }
              </select>
              <input 
                type="number"
                class="priority-input"
                placeholder="Priority"
                [ngModel]="newPriorityOverride()"
                (ngModelChange)="newPriorityOverride.set($event)"
              >
              <button 
                class="btn-add-assignment"
                (click)="addTemplateAssignment()"
                [disabled]="!selectedTemplateToAdd() || isAddingAssignment()"
              >
                @if (isAddingAssignment()) {
                  <span class="spinner-xs"></span>
                } @else {
                  + Add
                }
              </button>
            </div>
          </div>
        }
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeModal()">Cancel</button>
        <button 
          class="btn-create" 
          (click)="submitForm()"
          [disabled]="isSubmitting() || !isFormValid"
        >
          @if (isSubmitting()) {
            <span class="spinner-sm"></span>
          }
          {{ editingSource() ? 'Save Changes' : 'Create Source' }}
        </button>
      </div>
    </div>
  </div>
}

<!-- Toast -->
@if (showToast()) {
  <div class="toast" [class]="toastType()">
    {{ toastMessage() }}
  </div>
}
