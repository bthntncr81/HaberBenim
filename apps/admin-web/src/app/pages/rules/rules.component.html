<div class="page">
  <!-- Header -->
  <header class="page-header">
    <div class="header-content">
      <h1>Content Rules</h1>
      <p>Configure filtering and processing rules for incoming content</p>
    </div>
    <button class="btn-add" (click)="openNewRuleModal()">+ New Rule</button>
  </header>

  <!-- Loading -->
  @if (isLoading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Loading rules...</p>
    </div>
  } @else {
    <!-- Rules Table -->
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th class="col-priority">Priority</th>
            <th class="col-name">Name</th>
            <th class="col-decision">Decision</th>
            <th class="col-enabled">Enabled</th>
            <th class="col-trust">Min Trust</th>
            <th class="col-keywords">Include Keywords</th>
            <th class="col-keywords">Exclude Keywords</th>
            <th class="col-actions">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (rule of rules(); track rule.id) {
            <tr>
              <td class="col-priority">
                <span class="priority-badge">{{ rule.priority }}</span>
              </td>
              <td class="col-name">
                <span class="rule-name">{{ rule.name }}</span>
              </td>
              <td class="col-decision">
                <span class="decision-badge" [class]="rule.decisionType.toLowerCase()">
                  {{ getDecisionTypeLabel(rule.decisionType) }}
                </span>
              </td>
              <td class="col-enabled">
                <button 
                  class="btn-toggle" 
                  [class.active]="rule.isEnabled"
                  (click)="toggleRuleEnabled(rule)"
                >
                  {{ rule.isEnabled ? 'ON' : 'OFF' }}
                </button>
              </td>
              <td class="col-trust">
                @if (rule.minTrustLevel) {
                  <span class="trust-badge">â‰¥ {{ rule.minTrustLevel }}</span>
                } @else {
                  <span class="muted">Any</span>
                }
              </td>
              <td class="col-keywords">
                <span class="keywords-preview" [title]="rule.keywordsIncludeCsv || ''">
                  {{ truncate(rule.keywordsIncludeCsv, 30) }}
                </span>
              </td>
              <td class="col-keywords">
                <span class="keywords-preview exclude" [title]="rule.keywordsExcludeCsv || ''">
                  {{ truncate(rule.keywordsExcludeCsv, 30) }}
                </span>
              </td>
              <td class="col-actions">
                <button class="btn-edit" (click)="openEditRuleModal(rule)">Edit</button>
                <button class="btn-delete" (click)="deleteRule(rule)">Delete</button>
              </td>
            </tr>
          } @empty {
            <tr class="empty-row">
              <td colspan="8">
                <div class="empty-state">
                  <span class="empty-icon">ðŸ“‹</span>
                  <p>No rules defined yet</p>
                  <button class="btn-add-small" (click)="openNewRuleModal()">Create your first rule</button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>

<!-- Rule Modal -->
@if (showModal()) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content rule-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ isEditMode() ? 'Edit Rule' : 'New Rule' }}</h2>
        <button class="btn-close" (click)="closeModal()">âœ•</button>
      </div>
      
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group flex-grow">
            <label for="name">Name *</label>
            <input 
              type="text" 
              id="name" 
              [(ngModel)]="formData.name" 
              placeholder="e.g., High trust auto-publish"
            >
          </div>
          <div class="form-group">
            <label for="priority">Priority</label>
            <input 
              type="number" 
              id="priority" 
              [(ngModel)]="formData.priority" 
              min="0"
            >
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="decisionType">Decision Type *</label>
            <select id="decisionType" [(ngModel)]="formData.decisionType">
              @for (opt of decisionTypeOptions; track opt.value) {
                <option [value]="opt.value">{{ opt.label }}</option>
              }
            </select>
          </div>
          <div class="form-group">
            <label for="minTrustLevel">Min Trust Level</label>
            <select id="minTrustLevel" [(ngModel)]="formData.minTrustLevel">
              @for (opt of trustLevelOptions; track opt.value) {
                <option [ngValue]="opt.value">{{ opt.label }}</option>
              }
            </select>
          </div>
          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="formData.isEnabled">
              <span>Enabled</span>
            </label>
          </div>
        </div>

        <div class="form-group">
          <label for="keywordsInclude">Include Keywords (comma-separated)</label>
          <textarea 
            id="keywordsInclude" 
            [(ngModel)]="formData.keywordsIncludeCsv"
            placeholder="deprem, son dakika, breaking"
            rows="2"
          ></textarea>
          <span class="hint">Content must contain at least one of these keywords</span>
        </div>

        <div class="form-group">
          <label for="keywordsExclude">Exclude Keywords (comma-separated)</label>
          <textarea 
            id="keywordsExclude" 
            [(ngModel)]="formData.keywordsExcludeCsv"
            placeholder="casino, bet, spam"
            rows="2"
          ></textarea>
          <span class="hint">Rule will NOT match if content contains any of these</span>
        </div>

        <div class="form-group">
          <label>Sources (optional)</label>
          <div class="sources-grid">
            @for (source of sources(); track source.id) {
              <label class="source-checkbox">
                <input 
                  type="checkbox" 
                  [checked]="isSourceSelected(source.id)"
                  (change)="onSourceSelectionChange(source.id, $event)"
                >
                <span>{{ source.name }}</span>
              </label>
            } @empty {
              <span class="muted">No sources available</span>
            }
          </div>
          <span class="hint">If selected, rule only applies to these sources</span>
        </div>

        <div class="form-group">
          <label for="groupIds">Groups (comma-separated)</label>
          <input 
            type="text" 
            id="groupIds" 
            [(ngModel)]="formData.groupIdsCsv"
            placeholder="news, sports, tech"
          >
          <span class="hint">Rule matches sources in these groups</span>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeModal()">Cancel</button>
        <button 
          class="btn-save" 
          (click)="saveRule()"
          [disabled]="isSaving()"
        >
          @if (isSaving()) {
            <span class="spinner-sm"></span>
            Saving...
          } @else {
            {{ isEditMode() ? 'Update Rule' : 'Create Rule' }}
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Toast -->
@if (showToast()) {
  <div class="toast" [class]="toastType()">
    {{ toastMessage() }}
  </div>
}

